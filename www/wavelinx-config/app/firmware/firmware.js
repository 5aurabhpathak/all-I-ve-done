!function(){"use strict";function Firmware($state,$scope,$rootScope,firmwareService,GetUpdatedWACInfo,$modal,updateDeviceService,$timeout,spinnerService,$location,webService){function updateLogout(){logoutModalInstance.close(),sessionStorage.clear(),spinnerService.show(),secondTimeLogin()}function secondTimeLogin(){$.ajax({method:"GET",url:$location.host(),success:function(data){$state.go("login").then(function(){spinnerService.hide()})},error:function(err){secondTimeLogin()}})}function checkingForNewDevices(){$rootScope.checking=$timeout(function(){updateDeviceService.getOTAManager().then(function(response){vm.availableEndpoints=response.OtaEndpoints,_.each(vm.availableEndpoints,function(ep){var index=vm.availableEndpoints.indexOf(ep);vm.showPercent[index]=Math.floor(ep.ImageUpgradePercent)})}),$rootScope.currentState===$state.current.name&&checkingForNewDevices()},6e3)}function timeout(){$rootScope.timer=$timeout(function(){updateDeviceService.getOTAManager().then(function(response){vm.availableEndpoints=response.OtaEndpoints,vm.disableStartUpdate=response.IsRunning,_.each(vm.availableEndpoints,function(ep){var index=vm.availableEndpoints.indexOf(ep);vm.showPercent[index]=Math.floor(ep.ImageUpgradePercent)})}),timeout()},6e3)}function resetNotifications(){vm.updateStoppedMessage=vm.sameFileErrorMessage=vm.packageUploadSuccessMsg=vm.packageUploadErrorMsg=vm.startUpdateMessageSuccessfull=vm.startUpdateMessageFailed=null}var vm=this;$rootScope.currentState=$state.current.name,vm.packageUploadSuccessMsg,vm.packageUploadErrorMsg,vm.sameFileErrorMessage,vm.enableUploadButton=!1,vm.getWacInfo=GetUpdatedWACInfo,vm.getWacUpdateAvailableInfo=GetUpdatedWACInfo.updateInfo,vm.deviceList=!1,$rootScope.checking,$rootScope.timer,vm.noEndpointsText="No endpoints are available",vm.noUpgradesText="No upgrades available",vm.disableStartUpdate,vm.showPercent=[];var logoutModalInstance;vm.uploadFile=function(){resetNotifications(),vm.enableUploadButton=!0;1==$rootScope.logoutSuccess?(vm.deviceList=!1,updateDeviceService.logout().then(function(){firmwareService.uploadFile(vm.uploadFileName,!0).then(function(response){vm.getWacUpdateAvailableInfo=response.updateInfo,vm.enableUploadButton=!1,vm.packageUploadSuccessMsg='SUCCESS! "{0}" was successfully uploaded.'.format(vm.uploadFileName.name),vm.getWacInfo.currentWacVersion==vm.getWacUpdateAvailableInfo.fw_version&&(vm.sameFileErrorMessage="The file you uploaded matches the current available version. Please try to upload new file",vm.packageUploadSuccessMsg=null)},function(error){vm.packageUploadErrorMsg='ERROR! Could not upload "{0}".'.format(vm.uploadFileName.name),vm.enableUploadButton=!1})})):firmwareService.uploadFile(vm.uploadFileName,!0).then(function(response){vm.getWacUpdateAvailableInfo=response.updateInfo,vm.enableUploadButton=!1,vm.packageUploadSuccessMsg='SUCCESS! "{0}" was successfully uploaded.'.format(vm.uploadFileName.name),vm.getWacInfo.currentWacVersion==vm.getWacUpdateAvailableInfo.fw_version&&(vm.sameFileErrorMessage="The file you uploaded matches the current available version. Please try to upload new file",vm.packageUploadSuccessMsg=null)},function(error){vm.packageUploadErrorMsg='ERROR! Could not upload "{0}".'.format(vm.uploadFileName.name),vm.enableUploadButton=!1})},vm.update=function(){resetNotifications();var startWacUpdate={startWacUpdate:!0};1==$rootScope.logoutSuccess?(vm.deviceList=!1,updateDeviceService.logout().then(function(){firmwareService.updateFirmWare(startWacUpdate).then(function(result){var tmpScope=$rootScope.$new();tmpScope.updateLogout=updateLogout,logoutModalInstance=$modal.open({templateUrl:"app/layout/logoutPopup.html",scope:tmpScope,backdrop:"static",keyboard:!1})})})):firmwareService.updateFirmWare(startWacUpdate).then(function(result){webService.stopTimer();var tmpScope=$rootScope.$new();tmpScope.updateLogout=updateLogout,logoutModalInstance=$modal.open({templateUrl:"app/layout/logoutPopup.html",scope:tmpScope,backdrop:"static",keyboard:!1})})},vm.validateOTAUpdateName=function(fileName){return new RegExp("(.*?).(tgz)$").test(fileName)||new RegExp("(.*?).(ota)$").test(fileName)},vm.packageUploadBrowse=function(){setTimeout(function(){angular.element("#packageUploadBrowse").trigger("click")},0)},vm.open=function(){$modal.open({templateUrl:"app/updateDeviceLogin/updateDeviceLogin.html",controller:"UpdateDeviceLogin as vm",scope:$scope})},$rootScope.$on("responseGetOta",function(data,event){vm.disableStartUpdate=event.IsRunning,vm.isRunning=event.IsRunning,vm.availableEndpoints=event.OtaEndpoints,vm.availableOTAFiles=event.OtaFiles,event.IsRunning&&_.each(vm.availableEndpoints,function(ep){console.log("ep.ImageUpgradePercent",ep.ImageUpgradePercent);var index=vm.availableEndpoints.indexOf(ep);vm.showPercent[index]=Math.floor(ep.ImageUpgradePercent)}),event&&(vm.deviceList=!0),checkingForNewDevices()}),vm.startUpdate=function(){vm.isRunning=!0,vm.disableStartUpdate=!0,resetNotifications(),updateDeviceService.startUpdate().then(function(response){timeout()},function(error){console.log("firmware.js::startUpdate::error",error)})},vm.stopUpdate=function(){vm.disableStartUpdate=!1,resetNotifications(),updateDeviceService.stopUpdate().then(function(response){vm.updateStoppedMessage="Update Stopped",$timeout.cancel($rootScope.timer)},function(error){console.log("firmware.js::startUpdate::error",error)})},vm.logout=function(){updateDeviceService.logout().then(function(response){resetNotifications(),vm.deviceList=!1})},$rootScope.$on("$stateChangeStart",function(event){1==$rootScope.logoutSuccess&&vm.logout()})}angular.module("app.firmware").controller("Firmware",Firmware),Firmware.$inject=["$state","$scope","$rootScope","firmwareService","GetUpdatedWACInfo","$modal","updateDeviceService","$timeout","spinnerService","$location","webService"]}();